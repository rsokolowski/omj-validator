{% extends "base.html" %}

{% block title %}Zadanie {{ task.number }} - {{ task.year }} - OMJ Validator{% endblock %}

{% block content %}
<nav class="breadcrumb">
    <a href="/years">Lata</a>
    <span class="separator">/</span>
    <a href="/years/{{ task.year }}">{{ task.year }}</a>
    <span class="separator">/</span>
    <a href="/years/{{ task.year }}/{{ task.etap }}">
        {% if task.etap == "etap1" %}Etap I{% elif task.etap == "etap2" %}Etap II{% elif task.etap == "etap3" %}FinaÅ‚{% else %}{{ task.etap }}{% endif %}
    </a>
    <span class="separator">/</span>
    <span class="current">Zadanie {{ task.number }}</span>
</nav>

<div class="task-detail">
    <div class="task-detail-header">
        <h1>Zadanie {{ task.number }}</h1>
        <p class="task-title math-content">{{ task.title }}</p>
        <div class="task-meta">
            <span class="meta-item">{{ task.year }}</span>
            <span class="meta-item">{% if task.etap == "etap1" %}Etap I{% elif task.etap == "etap2" %}Etap II{% elif task.etap == "etap3" %}FinaÅ‚{% else %}{{ task.etap }}{% endif %}</span>
            {% if task.difficulty %}
            <span class="meta-item difficulty difficulty-{{ task.difficulty }}"
                  data-tooltip="{{ {1: 'Bardzo Å‚atwe - podstawowe zastosowanie wzorÃ³w', 2: 'Åatwe - wymaga prostego wglÄ…du', 3: 'Åšrednie - kilka krokÃ³w rozumowania', 4: 'Trudne - wymaga znacznego wglÄ…du', 5: 'Bardzo trudne - kreatywne podejÅ›cie'}[task.difficulty] }}">
                {% for i in range(task.difficulty) %}â˜…{% endfor %}{% for i in range(5 - task.difficulty) %}â˜†{% endfor %}
            </span>
            {% endif %}
            {% if task.categories %}
            {% for cat in task.categories %}
            <span class="meta-item category-badge category-{{ cat }}"
                  data-tooltip="{{ {'algebra': 'UkÅ‚ady rÃ³wnaÅ„, toÅ¼samoÅ›ci algebraiczne, nierÃ³wnoÅ›ci', 'geometria': 'Geometria pÅ‚aska: trÃ³jkÄ…ty, czworokÄ…ty, okrÄ™gi', 'teoria_liczb': 'PodzielnoÅ›Ä‡, liczby pierwsze, cyfry, rÃ³wnania diofantyczne', 'kombinatoryka': 'Zliczanie, dowody istnienia, zasada szufladkowa', 'logika': 'WaÅ¼enie, optymalizacja, teoria gier, strategia', 'arytmetyka': 'Åšrednie, stosunki, proste obliczenia'}[cat] }}">
                {{ {'algebra': 'Algebra', 'geometria': 'Geometria', 'teoria_liczb': 'Teoria liczb', 'kombinatoryka': 'Kombinatoryka', 'logika': 'Logika', 'arytmetyka': 'Arytmetyka'}[cat] }}
            </span>
            {% endfor %}
            {% endif %}
        </div>
        {% if prerequisite_statuses %}
        <div class="task-prerequisites-row">
            <span class="prerequisites-label">PowiÄ…zane zadania:</span>
            {% for prereq in prerequisite_statuses %}
            <a href="{{ prereq.url }}"
               class="prerequisite-link prerequisite-{{ prereq.status }}"
               data-math-tooltip="{{ prereq.title }}">
                <span class="prerequisite-icon">{% if prereq.status == 'mastered' %}âœ“{% else %}â—‹{% endif %}</span>
                Zad. {{ prereq.number }} ({{ prereq.year }})
            </a>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <div class="task-content-box">
        <h2>TreÅ›Ä‡ zadania</h2>
        <div class="task-content math-content">{{ task.content | nl2br_safe }}</div>
        {% if pdf_links %}
        <div class="pdf-links">
            {% if pdf_links.tasks %}
            <a href="{{ pdf_links.tasks }}" target="_blank" class="btn btn-secondary btn-small">
                Zadania PDF
            </a>
            {% endif %}
            {% if pdf_links.solutions %}
            <a href="{{ pdf_links.solutions }}" target="_blank" class="btn btn-secondary btn-small">
                RozwiÄ…zania PDF
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>

    {% if skills_required or skills_gained %}
    <div class="collapsible-section skills-section">
        <button class="collapsible-header" onclick="toggleCollapsible(this)">
            <h2>UmiejÄ™tnoÅ›ci</h2>
            <span class="collapsible-info">Kompetencje matematyczne zwiÄ…zane z zadaniem</span>
            <span class="collapsible-chevron">â–¶</span>
        </button>
        <div class="collapsible-content">
            {% if skills_required %}
            <div class="skills-group">
                <h3 class="skills-group-title">Wymagane umiejÄ™tnoÅ›ci</h3>
                <div class="skills-badges">
                    {% for skill in skills_required %}
                    <span class="skill-badge skill-required skill-{{ skill.category }}"
                          data-tooltip="{{ skill.description }}">
                        {{ skill.name }}
                    </span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if skills_gained %}
            <div class="skills-group">
                <h3 class="skills-group-title">UmiejÄ™tnoÅ›ci zdobyte</h3>
                <div class="skills-badges">
                    {% for skill in skills_gained %}
                    <span class="skill-badge skill-gained skill-{{ skill.category }}"
                          data-tooltip="{{ skill.description }}">
                        {{ skill.name }}
                    </span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if task.hints and task.hints|length > 0 %}
    <div class="collapsible-section hints-section">
        <button class="collapsible-header" onclick="toggleCollapsible(this)">
            <h2>WskazÃ³wki</h2>
            <span class="collapsible-info">Kliknij, aby odsÅ‚oniÄ‡ kolejne wskazÃ³wki</span>
            <span class="collapsible-chevron">â–¶</span>
        </button>
        <div class="collapsible-content">
            <div class="hints-list">
                {% set hint_labels = ['Zrozumienie', 'Strategia', 'Kierunek', 'WskazÃ³wka'] %}
                {% set hint_icons = ['ğŸ’¡', 'ğŸ¯', 'ğŸ§­', 'ğŸ”‘'] %}
                {% for hint in task.hints %}
                <div class="hint-item" data-hint-index="{{ loop.index0 }}">
                    <button class="hint-toggle" onclick="toggleHint(this)">
                        <span class="hint-icon">{{ hint_icons[loop.index0] }}</span>
                        <span class="hint-label">{{ hint_labels[loop.index0] }}</span>
                        <span class="hint-chevron">â–¶</span>
                    </button>
                    <div class="hint-content math-content">{{ hint }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <div class="submit-section">
        <h2>PrzeÅ›lij rozwiÄ…zanie</h2>
        {% if can_submit %}
        <p class="submit-info">PrzeÅ›lij zdjÄ™cia swojego rÄ™cznie napisanego rozwiÄ…zania. MoÅ¼esz przesÅ‚aÄ‡ wiele zdjÄ™Ä‡.</p>

        <form id="submit-form" class="submit-form" enctype="multipart/form-data">
            <div class="form-group">
                <label for="images" class="file-label">
                    <span class="file-label-text">Wybierz zdjÄ™cia</span>
                    <span class="file-label-hint">JPG, PNG, WebP (max {{ config.upload_max_size_mb if config else 10 }}MB kaÅ¼de)</span>
                </label>
                <input type="file" id="images" name="images" multiple
                       accept="image/jpeg,image/png,image/webp,image/heic"
                       class="file-input">
                <div id="file-preview" class="file-preview"></div>
            </div>

            <button type="submit" class="btn btn-primary" id="submit-btn">
                <span class="btn-text">PrzeÅ›lij do oceny</span>
                <span class="btn-loading" style="display: none;">AnalizujÄ™...</span>
            </button>
        </form>

        <div id="validation-progress" class="validation-progress" style="display: none;"></div>

        <div id="result-container" class="result-container" style="display: none;">
            <h3>Wynik oceny</h3>
            <div class="result-score">
                <span class="score-value" id="result-score">0</span>
                <span class="score-max">/ 6 punktÃ³w</span>
            </div>
            <div class="result-feedback" id="result-feedback"></div>
        </div>
        {% elif is_authenticated %}
        <div class="alert alert-info">
            <strong>â„¹</strong> PrzesyÅ‚anie rozwiÄ…zaÅ„ wymaga czÅ‚onkostwa w grupie <strong>omj-validator-alpha</strong>.
            Status czÅ‚onkostwa jest odÅ›wieÅ¼any automatycznie.
        </div>
        {% else %}
        <div class="alert alert-info">
            <strong>â„¹</strong> <a href="/login">Zaloguj siÄ™</a>, aby przesÅ‚aÄ‡ swoje rozwiÄ…zanie do oceny.
        </div>
        {% endif %}
    </div>

    {% if can_submit and submissions %}
    <div class="history-section">
        <div class="history-header">
            <h2>Ostatnie prÃ³by</h2>
            <a href="/task/{{ task.year }}/{{ task.etap }}/{{ task.number }}/history" class="btn btn-secondary btn-small">
                Zobacz wszystkie ({{ stats.submission_count if stats else 0 }})
            </a>
        </div>

        <div class="submissions-list">
            {% for sub in submissions %}
            <div class="submission-card">
                <div class="submission-header">
                    <span class="submission-date">{{ sub.timestamp.strftime('%d.%m.%Y %H:%M') }}</span>
                    <span class="submission-score score-{{ sub.score }}">{{ sub.score }}/6</span>
                </div>
                <div class="submission-feedback">{{ sub.feedback }}</div>
                {% if sub.images %}
                <div class="submission-images">
                    {% for img in sub.images %}
                    <a href="/uploads/{{ img }}" target="_blank" class="submission-image-link">
                        <img src="/uploads/{{ img }}" alt="RozwiÄ…zanie" class="submission-image-thumb">
                    </a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    initTaskPage('{{ task.year }}', '{{ task.etap }}', {{ task.number }});
</script>
{% endblock %}
